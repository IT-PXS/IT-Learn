---
title: Linux（3-系统排查）
tags: Linux
categories: 运维
cover: /img/index/linux.jpg
top_img: /img/index/linux.jpg
published: false
abbrlink: 16020
date: 2024-11-18 23:11:11
description:
---

## CPU

### top

![](Linux（3-系统排查）/1.png)

**重要属性**

1. us：用户空间占用 CPU 百分比
2. sy：内核空间占用 CPU 百分比
3. ni：用户进程空间内改变过优先级的进程占 CPU 百分比
4. id：空闲 CPU 百分比
5. wa：等待输入输出的 CPU 时间百分比（CPU 运行时在等待 IO 的时间）
6. hi：CPU 服务于硬件中间所耗费的时间总额（CPU 处理硬中断的数量）
7. si：CPU 服务软中断所耗费的时间总额（CPU 处理软中断的数量）
8. st：被虚拟机偷走的 CPU
9. load average：系统的负载均衡，三个值，代表系统的 1 分钟，5 分钟，15 分钟的平均负载值，如果 3 个值相加再除以三，乘上 100%大于了 60%，证明系统的负担压力重了

+ 在本页面按 1，可以看到不同的 CPU 的不同负载
+ CTRL+Z：退出 top 命令；

**其他属性**

1. PID：进程 ID
2. USER：进程所有者
3. PR：优先级
4. NI：nice 值，负值表示高优先级，正值表示低优先级
5. VIRT：进程使用的虚拟内存总量
6. SHR：共享内存大小
7. S：进程状态
8. %CPU：上次更新到现在的 CPU 时间占用百分比
9. %MEM：进程使用的物理内存百分比
10. TIME+：进程使用 CPU 总时间
11. COMMAND：命令名、命令行
### uptime
系统性能命令的精简版

![](Linux（3-系统排查）/2.png)

### vmstat
![](Linux（3-系统排查）/3.png)

**使用案例**

```shell
vmstat -n 2 3：系统采样，2秒间隔，采样3次
一般vmstat工具的使用是通过两个数字参数来完成的，第一个参数是采样的时间间隔数单位是秒，第二个参数是采样的次数
```

**基本属性**

1. procs

+ r：运行和等待 CPU 时间片的进程数，原则上 1 核的 CPU 的运行队列不要超过 2（r 的加字除以采样次数，(5+0+0)/3 = 1.6667 < 2），整个系统的运行队列不能超过总核数的 2 倍，否则代表系统压力过大
+ b：等待资源的进程数，比如：正在等待磁盘 I/O、网络 I/O 等。
2. cpu
+ us（用户）：用户进程消耗 CPU 时间百分比，us 值高，用户进程消耗 CPU 时间多，如果长期大于 50%，优化程序；
+ sy（系统）：内核进程消耗的 CPU 时间百分比；
+ us+sy：参考值为 80%，如果 us+sy 大于 80%，说明可能存在 CPU 不足。
+ id：处于空闲的 CPU 百分比
+ wa：系统等待 IO 的 CPU 时间百分比
+ st：来自于一个虚拟机偷取的 CPU 时间的百分比

## 磁盘
### df
df：查看磁盘占用的空间

命令：df  [选项]  [文件]

1. -a：列出所有的文件系统，包括系统特有的 /proc 等文件系统；
2. -k：以 KBytes 的容量显示各文件系统；
3. -m：以 MBytes 的容量显示各文件系统；
4. -h：以人们较易阅读的 GBytes, MBytes, KBytes 等格式自行显示；
5. -H：以 M = 1000K 取代 M = 1024K 的进位方式；
6. -T：显示文件系统类型, 连同该 partition 的 filesystem 名称 (例如 ext3) 也列出；
7. -i：不用硬盘容量，而以 inode 的数量来显示

**使用案例**

```shell
df：显示磁盘使用情况
df -i：以inode模式来显示磁盘使用情况
df -t ext：显示指定类型磁盘
df -ia：列出各文件系统的i节点使用情况
df -T：列出文件系统的类型
df -h：以更易读方式显示目前磁盘空间和使用情况
```

![](Linux（3-系统排查）/4.png)

**基本属性**

1. Filesystem：表示该文件系统位于哪个分区，因此该列显示的是设备名称；
2. Used：表示用掉的磁盘空间大小；
3. Available：表示剩余的磁盘空间大小；
4. Use%：磁盘空间使用率;
5. Mounted on：文件系统的挂载点，也就是磁盘挂载的目录位置

### du
du：查看目录或文件所占磁盘空间的大小

命令：du  [选项]  [文件]

1. -h：以人类可读的方式显示
2. -a：显示目录占用的磁盘空间大小，还要显示其下目录和文件占用磁盘空间的大小
3. -s：显示目录占用的磁盘空间大小，不要显示其下子目录和文件占用的磁盘空间大小
4. -c：显示几个目录或文件占用的磁盘空间大小，还要统计它们的总和
5. --apparent-size：显示目录或文件自身的大小
6. -l ：统计硬链接占用磁盘空间的大小
7. -L：统计符号链接所指向的文件占用的磁盘空间大小

**使用案例**

```shell
du：显示目录或文件所占空间
du log2012.log：显示指定文件所占空间
du scf：查看指定目录所占空间
du log30.log log31.log：显示多个文件所占空间
du -s：只显示总和的大小
du -h test：方便阅读的格式显示
du -ah test：文件和目录都显示
du -c log30.log log31.log：显示几个文件或目录各自占用磁盘空间的大小，并统计它们的总和
```

![](Linux（3-系统排查）/9.png)

**du 和 df 的区别**

1. du 是通过搜索文件来计算每个文件的大小然后累加，du 能看到的文件是一些当前存在的（没有被删除的），计算的大小就是当前他认为存在的所有文件大小的累加和
2. df 是通过文件系统来快速获取空间大小的信息，当我们删除一个文件的时候，这个文件不是马上在文件系统当中消失了，而是暂时消失了，当所有程序都不用时才会根据 OS 的规则释放掉已经删除的文件，计算大小的时候会把这部分空间加上

### iostat
iostat：查看磁盘 I/O 性能

1. -t：显示 tty 和 CPU 信息
2. -d：显示磁盘使用情况
3. -x：显示详细信息

![](Linux（3-系统排查）/5.png)

**基本属性**

1. rkB/s：每秒读取数据量 kB；
2. wkB/s：每秒写入数据量 kB；
3. svctm：I/O 请求的平均服务时间，单位毫秒；
4. await：I/O 请求的平均等待时间，单位毫秒；值越小，性能越好；
5. util：一秒中有百分几的时间用于 I/O 操作。接近 100%时，表示磁盘带宽跑满，需要优化程序或者增加磁盘；
6. rkB/s、wkB/s：根据系统应用不同会有不同的值，但有规律遵循，长期、超大数据读写，肯定不正常，需要优化程序读取。
7. svctm：svctm 的值与 await 的值很接近，表示几乎没有/O 等待，磁盘性能好。如果 await 的值远高于 svctm 的值，则表示 I/O 队列等待太长，需要优化程序或更换更快磁盘。

## 内存
### free
free 命令默认显示单位 kb，显示系统使用和空间的内存情况，包括物理内存、交互区内存（swap）和内核缓冲区内存，共享内存将被忽略

1. -h：会自动选择以适合理解的容量单位显示
2. -b 　以 Byte 为单位显示内存使用情况。 
3. -k：以 KB 为单位显示内存使用情况。 
4. -m：以 MB 为单位显示内存使用情况。
5. -g：以 GB 为单位显示内存使用情况。 
6. -o：不显示缓冲区调节列。 
7. -s <间隔秒数>：持续观察内存使用状况。 
8. -t：显示内存总和列。
9. -V：显示版本信息。 

![](Linux（3-系统排查）/6.png)

**基本属性**

1. total：总计物理内存的大小。
2. used：已使用多大。
3. free：可用有多少。
4. Shared：多个进程共享的内存总额。
5. Buff/cache：磁盘缓存的大小。

## 网络
### ifconfig

```shell
# 显示网络设备信息
ifconfig  
# 启动关闭指定网卡
ifconfig eth0 down/up等于ifdown/ifup eth0
# 设置最大传输单元
ifconfig eth0 mtu 1500 
# 临时修改 IP
ifconfig ens33 192.168.10.20/24
# 建立虚拟网卡(网卡别名)，流量走主网卡
ifconfig ens33:0 192.168.10.21
ifconfig ens33:1 192.168.10.22
# 单独显示某网卡
ifconfig eth0
```

![](Linux（3-系统排查）/10.png)

### ping

ping [参数选项] [主机名或 IP 地址]：查看 IP 地址的连接情况

1. -c：设置完成要求回应的次数
2. -i：指定收发信息的间隔时间
3. -s：设置数据包的大小
4. -w：在设定的秒后退出

![](Linux（3-系统排查）/11.png)

### traceroute
traceroute [参数] [主机|IP]：查看 IP 地址经过的信息

1. -d：使用 Socket 层级的排错功能
2. -f：设置第一个检测数据包的存活数值 TTL 的大小
3. -F：设置勿离断位
4. -g：设置来源路由网关，最多可设置 8 个
5. -i：使用指定的网络界面送出数据包
6. -I：使用 ICMP 回应取代 UDP 资料信息
7. -m：设置检测数据包的最大存活数值 TTL 的大小
8. -n：直接使用 IP 地址而非主机名称
9. -p：设置 UDP 传输协议的通信端口
10. -r：忽略普通的 Routing Table，直接将数据包送到远端主机上
11. -s：设置本地主机送出数据包的 IP 地址
12. -t：设置检测数据包的 TOS 数值
13. -v：详细显示指令的执行过程
14. -w：设置等待远端主机回报的时间
15. -x：开启或关闭数据包的正确性检验

### nslookup
nslookup 域名：查看域名对应的 IP 地址

![](Linux（3-系统排查）/7.png)

**配置文件信息**

```shell
[root@c7-1 ~]#cat /etc/resolv.conf	#域名解析配置文件
# Generated by NetworkManager
# 一行一个 DNS，最多配置三个 DNS，优先使用第一个 DNS 服务器
nameserver 20.0.0.2

[root@c7-1 ~]#cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
112.80.248.75 www.baidu.com
#/etc/hosts 文件中记录着一份主机名与 IP 地址的映射关系表，一般用来保存经常需要访问的主机的信息。
# 当访问一个未知的域名时，先查找该文件中是否有相应的映射记录，如果找不到再去向 DNS 服务器查询。
```

### dig
dig 域名：查询 DNS 域名信息

![](Linux（3-系统排查）/8.png)

**ANSWER SECTION基本属性**

1. 第一列：被查询的服务器名称
2. 第二列： TTL（存活时间），在此之后记录将被刷新
3. 第三列：查询的类别 – IN 代表互联网
4. 第四列：查询的类型 – CNAME 代表 CNAME（别名）记录，A 代表 A（地址）记录
5. 最后一列：与域名关联的别名和 IP 地址（结果）

### nmcli
### tcpdump
## 进程
### 查看进程
ps [可选参数]：查看目前系统中，有哪些正在执行的进程，以及这些进程执行的情况，可以不加任何参数

1. -a：显示当前终端的所有进程信息
2. -u：以用户的格式显示进程信息
3. -x：显示后台进程运行的参数
4. -f：额外显示 UID、PPID、C 与 STIME 栏位
5. -e：显示所有进程

```shell
ps -aux 				#查看详细信息，太多可以使用 more 分页查看，ps -aux | more
ps -aux | grep xxxx   	#使用 grep 过滤查找，System V 展示风格

# 查看进程
ps -ef | more  			#分页查看
ps -ef | grep xxx   	#是BSD 风格
```

![](https://cdn.nlark.com/yuque/0/2023/png/12836966/1679218523967-e34d836b-5810-4d21-bb97-ac64f251b11a.png)

### 终止进程
1. <font style="color:#000000;"> kill  进程号/kill  -9  进程号：杀死进程，-9 为强制杀死 </font>
+ HUP（1）：挂起，通常因终端掉线或用户退出而引发
+ INT（2）：中断，通常为按下 Ctrl+C 组合键发出该信号
+ QUIT（3）：退出，通常为按下 Ctrl+\组合键发出该信号
+ KILL（9）：立即结束进程的运行
+ TERM（15）：终止，通常在系统关机时发送
+ TSTP（20）：暂停进程的运行，通常是按下 Ctrl+Z 组合键发出该信号
2. <font style="color:#000000;"> killall  进程名称：通过进程名称杀死进程，也支持通配符 </font>
3. <font style="color:#000000;"> pkill  进程名称：通常进程名称杀死进程及其所有子进程 </font>
+ -u：终止指定用户的进程
+ -t：杀死指定终端的进程

### 进程监控
top [可选参数]：显示系统每个进程的资源占用情况

### 进程后台执行
nohup 执行命令

```java
nohup ping www.baidu.com
```

## 端口
### netstat
1. -t：显示 TCP 端口
2. -u：显示 UDP 端口
3. -l：仅显示套接字
4. -p：显示进程标识符和程序名称
5. -n：不进行 DNS 轮询，显示 IP

```shell
# 查看所有端口
netstat -ntlp
# 查看某个进程的端口号
netstat -anp | grep 546
# 查看某一个端口号
netstat -ntlp | grep 8083
```

### lsof
lsof -i: 端口号：查看端口信息

### ss
ss 是一个更现代化的工具，用于显示套接字统计信息。它比 netstat 更快速和高效

ss -tuln | grep 端口号

1. -t：显示 TCP 连接信息
2. -u：显示 UDP 连接信息
3. -l：仅显示监听状态的端口
4. -n：使用数字格式显示端口号，而不是服务名

```shell
示本地打开的所有端口
ss -l
#列出当前 socket 详细信息
ss -s
#显示每个进程具体打开的 socket
ss -pl
#显示所有 tcp socket
ss -at
#显示所有的 udp socket
ss -au
#显示所有已建立的 ssh 连接
ss -o state established '( dport = :ssh or sport = :ssh )'
#显示所有已建立的 HTTP 连接
ss -o state established '( dport = :http or sport = :http )'
# 查看端口号 80 是否被占用
ss -tuln | grep 80
```

## 防火墙
1. systemctl  status  firewalld：查看防火墙是否开启
2. systemctl  start  firewalld：开启防火墙
3. systemctl  stop  firewalld：关闭防火墙
4. firewall-cmd  --list-ports：查看所有开启的端口
5. firewall-cmd  --state：查看防火墙状态，是否是 running
6. firewall-cmd  --reload：重新载入配置，比如：添加规则之后，需要执行此命令
7. firewall-cmd  --get-zones：列出支持的 zone
8. firewall-cmd  --get-services：列出支持的服务，在列表中的服务是放行的
9. firewall-cmd  --query-service  ftp：查看 ftp 服务是否支持，返回 yes 或者 no
10. firewall-cmd  --add-service = ftp：临时开放 ftp 服务
11. firewall-cmd  --add-service = ftp  --permanent：永久开放 ftp 服务
12. firewall-cmd  --remove-service = ftp  --permanent：永久移除 ftp 服务
13. firewall-cmd  --add-port = 80/tcp  --permanent：永久添加 80 端口
14. iptables  -L  -n：查看规则

